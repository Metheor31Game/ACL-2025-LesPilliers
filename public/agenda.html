<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>Mon Agenda</title>
    <link rel="stylesheet" href="/output.css" />
  </head>
  <body class="bg-gray-100 min-h-screen flex flex-col items-center p-6">
    <div class="max-w-2xl w-full bg-white rounded-lg shadow p-6">
      <h1 class="text-2xl font-bold mb-4 text-center">Mes Agendas</h1>

      <div class="flex mb-4">
        <input id="agendaNom" placeholder="Nom de l’agenda" class="border p-2 flex-1 rounded-l" />
        <button id="btnAddAgenda" class="bg-blue-500 text-white px-4 rounded-r">Ajouter</button>
      </div>

      <div id="agendas"></div>

      <button id="logoutBtn" class="mt-6 bg-red-500 text-white px-4 py-2 rounded">
        Déconnexion
      </button>
    </div>

    <script>
      async function chargerAgendas() {
        const res = await fetch("/api/agenda");
        if (res.status === 401) {
          window.location.href = "connexion.html";
          return;
        }
        const agendas = await res.json();
        afficherAgendas(agendas);
      }

      function afficherAgendas(agendas) {
        const container = document.getElementById("agendas");
        container.innerHTML = "";
        agendas.forEach((a) => {
          const div = document.createElement("div");
          div.className = "border rounded p-4 mb-4";

          let rdvList = "";
          a.rdvs.forEach(
            (r) =>
              (rdvList += `<li class='flex justify-between'>
                ${r.titre} - ${new Date(r.date).toLocaleString()}
                <button onclick="supprimerRdv('${a._id}','${r._id}')" class='text-red-500'>x</button>
              </li>`)
          );

          div.innerHTML = `
            <h2 class="font-bold mb-2">${a.nom}</h2>
            <ul class="mb-2">${rdvList || "<li>Aucun RDV</li>"}</ul>
            <div class="flex">
              <input id="titre-${a._id}" placeholder="Titre" class="border p-1 mr-1 flex-1" />
              <input id="date-${a._id}" type="datetime-local" class="border p-1 mr-1 flex-1" />
              <button onclick="ajouterRdv('${a._id}')" class="bg-green-500 text-white px-2 rounded">+</button>
            </div>
          `;
          container.appendChild(div);
        });
      }

      async function ajouterRdv(agendaId) {
        const titre = document.getElementById("titre-" + agendaId).value;
        const date = document.getElementById("date-" + agendaId).value;
        if (!titre || !date) return alert("Remplis le titre et la date");

        await fetch(`/api/agenda/${agendaId}/rdv`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ titre, date }),
        });

        chargerAgendas();
      }

      async function supprimerRdv(agendaId, rdvId) {
        await fetch(`/api/agenda/${agendaId}/rdv/${rdvId}`, { method: "DELETE" });
        chargerAgendas();
      }

      document.getElementById("btnAddAgenda").addEventListener("click", async () => {
        const nom = document.getElementById("agendaNom").value;
        if (!nom) return alert("Nom obligatoire");
        await fetch("/api/agenda", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ nom }),
        });
        chargerAgendas();
      });

      document.getElementById("logoutBtn").addEventListener("click", async () => {
        await fetch("/api/auth/logout", { method: "POST" });
        window.location.href = "connexion.html";
      });

      chargerAgendas();
    </script>
  </body>
</html>
